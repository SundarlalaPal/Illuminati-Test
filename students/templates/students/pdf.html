{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:title" content="Illuminati" />
  <meta property="og:image" content="{% static 'images/favicon.png' %}" />
  <meta property="og:description" content="Study" />
  <title>PDF Viewer</title>
  <link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f9fafb;
    }

    .pdf-wrapper {
      max-height: 85vh;
      overflow-y: auto;
      background-color: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    canvas {
      display: block;
      margin: 1.5rem auto;
      border-radius: 0.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
      .controls > * {
        width: 100% !important;
      }
    }
  </style>
</head>

<body class="text-gray-900 dark:bg-gray-900 dark:text-gray-200">

  <div class="max-w-5xl mx-auto p-4">
    <h2 class="text-3xl font-semibold text-center mb-6">📄 PDF Viewer (Vertical Mode)</h2>

    <!-- Controls -->
    <div class="controls flex flex-wrap justify-center gap-3 mb-6">
      <button onclick="zoomIn()" class="bg-green-500 text-white px-4 py-2 rounded-lg shadow hover:bg-green-600">
        🔍➕ Zoom In
      </button>
      <button onclick="zoomOut()" class="bg-red-500 text-white px-4 py-2 rounded-lg shadow hover:bg-red-600">
        🔍➖ Zoom Out
      </button>
      <div class="flex items-center bg-gray-100 dark:bg-gray-800 px-3 py-2 rounded-lg shadow">
        <input
          type="number"
          id="page-num"
          min="1"
          placeholder="Page"
          class="w-16 text-center bg-transparent focus:outline-none dark:text-white"
          onchange="goToPage(this.value)"
        />
        <span class="ml-2 text-sm">/ <span id="total-pages">?</span></span>
      </div>
    </div>

    <!-- PDF Container -->
    <div id="pdf-container" class="pdf-wrapper"></div>

    <!-- CSRF and Close -->
    <input type="hidden" id="csrf_token" value="{{ csrf_token }}" />
    <button onclick="sendodfData('ok')" class="block mx-auto mt-6 px-6 py-3 bg-yellow-500 text-white rounded-lg shadow hover:bg-yellow-600">
      ✅ Close & Submit
    </button>
  </div>

  <!-- Script -->
  <script>
    let pdfDoc = null,
        scale = 1.5,
        pdfData = "{{ pdf_content|safe }}",
        pdfUrl = "data:application/pdf;base64," + pdfData;

    const container = document.getElementById('pdf-container');

    // Load PDF
    pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
      pdfDoc = pdf;
      document.getElementById('total-pages').textContent = pdf.numPages;
      renderAllPages();
    });

    // Render all pages
    function renderAllPages() {
      container.innerHTML = '';
      for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
        pdfDoc.getPage(pageNum).then(page => {
          const viewport = page.getViewport({ scale });
          const outputScale = window.devicePixelRatio || 1;

          const canvas = document.createElement('canvas');
          canvas.id = `page-${page.pageNumber}`;
          const ctx = canvas.getContext('2d');

          canvas.width = viewport.width * outputScale;
          canvas.height = viewport.height * outputScale;
          canvas.style.width = viewport.width + 'px';
          canvas.style.height = viewport.height + 'px';

          const transform = [outputScale, 0, 0, outputScale, 0, 0];

          page.render({
            canvasContext: ctx,
            viewport,
            transform
          });

          container.appendChild(canvas);
        });
      }
    }

    // Scroll to page
    function goToPage(num) {
      const page = parseInt(num);
      if (page >= 1 && page <= pdfDoc.numPages) {
        const target = document.getElementById(`page-${page}`);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }
    }

    // Zoom controls
    function zoomIn() {
      scale += 0.2;
      renderAllPages();
    }

    function zoomOut() {
      if (scale > 0.5) {
        scale -= 0.2;
        renderAllPages();
      }
    }

    // Submit close action
    function sendodfData(allow) {
      const data = { "is_okk": allow };
      fetch(window.location.href, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.getElementById("csrf_token").value
        },
        body: JSON.stringify(data)
      })
        .then(response => response.json())
        .then(data => {
          alert(data.message || data.error);
          setTimeout(() => location.reload(), 500);
        })
        .catch(error => console.error("Error:", error));
    }
  </script>

</body>
</html>
