{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:title" content="Illuminati" />
  <meta property="og:image" content="{% static 'images/favicon.png' %}" />
  <meta property="og:description" content="Study Materials Viewer" />
  <title>PDF Viewer - Illuminati Coaching Centre</title>
  <link rel="icon" href="{% static 'images/favicon.ico' %}" type="image/x-icon" />

  <!-- Tailwind & Flowbite -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(120deg, #f1f5f9, #e0f2fe);
      color: #1e293b;
    }

    .pdf-card {
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.85);
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      overflow: hidden;
      padding: 1rem;
    }

    #zoom-container {
      transform-origin: center center;
      touch-action: none;
      transition: transform 0.1s ease;
      will-change: transform;
    }

    canvas {
      display: block;
      margin: 1rem auto;
      border-radius: 0.5rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
      .controls > * {
        width: 100% !important;
      }
    }
  </style>
</head>

<body class="bg-gray-100">

  <!-- NAVBAR -->
  <nav class="bg-blue-800 sticky top-0 z-50 shadow-lg">
    <div class="max-w-screen-xl flex justify-between items-center mx-auto p-4">
      <a href="/" class="flex items-center space-x-3">
        <img src="{% static 'images/logo2.png' %}" class="h-8" alt="Logo">
        <span class="text-white text-2xl font-bold">Illuminati</span>
      </a>
      <div class="text-white space-x-4 hidden md:flex">
        <a href="/" class="hover:text-yellow-300">Home</a>
        <a href="#join" class="hover:text-yellow-300">Join</a>
        <a href="#contact" class="hover:text-yellow-300">Contact</a>
      </div>
    </div>
  </nav>

  <!-- MAIN SECTION -->
  <section class="max-w-6xl mx-auto py-12 px-4">
    <h2 class="text-3xl font-extrabold text-center text-blue-800 mb-6">ðŸ“˜ View Study Material</h2>

    <!-- CONTROLS -->
    <div class="controls flex flex-wrap justify-center gap-4 mb-6">
      <button onclick="zoomIn()" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition">âž• Zoom In</button>
      <button onclick="zoomOut()" class="bg-red-600 text-white px-4 py-2 rounded-lg shadow hover:bg-red-700 transition">âž– Zoom Out</button>
      <button onclick="resetZoom()" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition">ðŸ”„ Reset Zoom</button>
      <div class="flex items-center bg-gray-200 px-3 py-2 rounded-lg shadow">
        <input type="number" id="page-num" min="1" placeholder="Page #" class="w-16 text-center bg-transparent focus:outline-none text-blue-900 font-semibold" onchange="goToPage(this.value)" />
        <span class="ml-2 text-sm text-gray-600">/ <span id="total-pages">?</span></span>
      </div>
    </div>

    <!-- PDF CARD VIEWER -->
    <div class="pdf-card">
      <div id="zoom-wrapper">
        <div id="zoom-container">
          <div id="pdf-container"></div>
        </div>
      </div>
    </div>

    <!-- CLOSE BUTTON -->
    <input type="hidden" id="csrf_token" value="{{ csrf_token }}" />
    <button onclick="sendodfData('ok')" class="mt-8 block mx-auto px-6 py-3 bg-yellow-500 text-white font-bold rounded-lg shadow hover:bg-yellow-600 transition">âœ… Close & Submit</button>
  </section>

  <!-- JS LOGIC -->
  <script>
    let pdfDoc = null,
        scale = 1.5,
        pdfData = "{{ pdf_content|safe }}",
        pdfUrl = "data:application/pdf;base64," + pdfData;

    const container = document.getElementById('pdf-container');
    const zoomContainer = document.getElementById('zoom-container');

    pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
      pdfDoc = pdf;
      document.getElementById('total-pages').textContent = pdf.numPages;
      renderAllPages();
    });

    function renderAllPages() {
      container.innerHTML = '';
      for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
        pdfDoc.getPage(pageNum).then(page => {
          const viewport = page.getViewport({ scale });
          const outputScale = window.devicePixelRatio || 1;
          const canvas = document.createElement('canvas');
          canvas.id = `page-${page.pageNumber}`;
          const ctx = canvas.getContext('2d');

          canvas.width = viewport.width * outputScale;
          canvas.height = viewport.height * outputScale;
          canvas.style.width = viewport.width + 'px';
          canvas.style.height = viewport.height + 'px';

          page.render({
            canvasContext: ctx,
            viewport,
            transform: [outputScale, 0, 0, outputScale, 0, 0]
          });

          container.appendChild(canvas);
        });
      }
    }

    function goToPage(num) {
      const page = parseInt(num);
      if (page >= 1 && page <= pdfDoc.numPages) {
        const target = document.getElementById(`page-${page}`);
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }
    }

    function zoomIn() {
      scale += 0.2;
      renderAllPages();
    }

    function zoomOut() {
      if (scale > 0.5) {
        scale -= 0.2;
        renderAllPages();
      }
    }

    function resetZoom() {
      currentScale = 1;
      translateX = 0;
      translateY = 0;
      zoomContainer.style.transform = `scale(1) translate(0px, 0px)`;
    }

    function sendodfData(allow) {
      const data = { "is_okk": allow };
      fetch(window.location.href, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": document.getElementById("csrf_token").value
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message || data.error);
        setTimeout(() => location.reload(), 500);
      })
      .catch(error => console.error("Error:", error));
    }

    // ðŸ‘‰ TOUCH ZOOM, DRAG, DOUBLE TAP
    let currentScale = 1, translateX = 0, translateY = 0;
    let pinchStartDistance = 0, lastTouchEnd = 0;
    let startX = 0, startY = 0, isDragging = false;

    function getPinchDistance(touches) {
      const dx = touches[0].clientX - touches[1].clientX;
      const dy = touches[0].clientY - touches[1].clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }

    zoomContainer.addEventListener("touchstart", (e) => {
      if (e.touches.length === 2) {
        pinchStartDistance = getPinchDistance(e.touches);
      } else if (e.touches.length === 1 && currentScale > 1) {
        isDragging = true;
        startX = e.touches[0].clientX - translateX;
        startY = e.touches[0].clientY - translateY;
      }
    }, { passive: false });

    zoomContainer.addEventListener("touchmove", (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const currentDistance = getPinchDistance(e.touches);
        const scaleFactor = currentDistance / pinchStartDistance;
        let newScale = currentScale * scaleFactor;
        newScale = Math.min(Math.max(newScale, 0.5), 3);
        zoomContainer.style.transform = `scale(${newScale}) translate(${translateX}px, ${translateY}px)`;
      } else if (isDragging && e.touches.length === 1) {
        e.preventDefault();
        translateX = e.touches[0].clientX - startX;
        translateY = e.touches[0].clientY - startY;
        zoomContainer.style.transform = `scale(${currentScale}) translate(${translateX}px, ${translateY}px)`;
      }
    }, { passive: false });

    zoomContainer.addEventListener("touchend", (e) => {
      if (e.touches.length < 2) {
        const match = zoomContainer.style.transform.match(/scale\(([^)]+)\)/);
        if (match) currentScale = parseFloat(match[1]);
        isDragging = false;
      }
    });

    zoomContainer.addEventListener("touchend", function (e) {
      const now = new Date().getTime();
      if (now - lastTouchEnd <= 300 && e.touches.length === 0) {
        e.preventDefault();
        currentScale = currentScale > 1 ? 1 : 2;
        translateX = 0;
        translateY = 0;
        zoomContainer.style.transform = `scale(${currentScale}) translate(0px, 0px)`;
      }
      lastTouchEnd = now;
    });
  </script>
</body>
</html>
